#!/bin/bash
#parametros 1--> debe ser /etc/passwd o /etc/shadow (con sudo)
#nombre demasiado corto
#comprobacion de parametros
largo=5
dias=300
if(($# == 2));then
	largo=$1
	dias=$2
fi
mkdir archivosp1.1
cat /etc/passwd | cut -d':' -f1 >archivosp1.1/fileA
cat /etc/passwd | cut -d':' -f 1,3,4 | tr ':' ' ' > archivosp1.1/fileB
echo '--------------------------------'
echo 'Nombres (Mirar carpeta archivosp1.1)'
echo "Nombres, Adecuado >= $largo" > archivosp1.1/nombresCortos
echo "Nombres, Adecuado >= $largo" > archivosp1.1/nombresAdecuados
while IFS= read -r line
do
	#echo "$line"
	if((${#line} < largo));then
		echo "$line" >> archivosp1.1/nombresCortos
	else
		echo "$line" >> archivosp1.1/nombresAdecuados
	fi
done < archivosp1.1/fileA
#comprobar permisos de sudoers
echo '--------------------------------'
echo 'Permisos sudoers'
cont=0
while IFS= read -r line
do
	string=($line)
	if [ ${string[1]} -eq 0 ] && [ ${string[2]} -eq 0 ];then
		echo "${string[0]}" >> archivosp1.1/usuariosconPermisos
		let cont=cont+1
	else
		echo "${string[0]}" >> archivosp1.1/usuariossinPermisos
	fi

done < archivosp1.1/fileB
echo "Hay $cont usuarios con permisos elevados"

echo '--------------------------------'
echo 'Fechas'

sudo cat /etc/shadow | cut -d':' -f1,3 | tr ':' ' ' > archivosp1.1/fileC

#cat fileC
echo "Dias, Adecuado <= $dias"
numDiasHastaHoy=$(($(date --utc --date "$1" +%s)/86400))
echo "dias hasta hoy: $numDiasHastaHoy"
echo "parametro dias: $dias"
while IFS= read -r line
do
	string=($line)
	let restaDias=$numDiasHastaHoy-${string[1]} 
	if [ $restaDias -gt $dias ];then
		echo "${string[0]}" >> archivosp1.1/muchotiempoPasswd
	fi
done < archivosp1.1/fileC

echo '--------------------------------'
echo 'Permisos others y SETUID activo(ver carpeta archivosp1.1)'
sudo find / -type f -perm /o=x > archivosp1.1/archivosEjecucionOthers 2> error


sudo find / -type f -perm /4000 > archivosp1.1/archivosSUID 2>> error
echo '--------------------------------'
echo 'Bit X activado comprimidos (ver carpeta archivosp1.1)'
cd archivosp1.1
echo "Archivos .tgz" > permisosComprimidos
sudo find / -name "*.tgz" > archivosTgz 2>> error
while IFS= read -r line
do
	tar -xvzf $line > comprimidos
	
	while IFS= read -r linea
	do
		find $linea -perm /o=x >> permisosComprimidos 2>> error
	done < comprimidos

done < archivosTgz
echo "Archivos .tar" >> permisosComprimidos
sudo find / -name "*.tar" > archivosTgz 2>> error
while IFS= read -r line
do
	tar xvf $line > comprimidos
	
	while IFS= read -r linea
	do
		find $linea -perm /o=x >> permisosComprimidos 2>> error
	done < comprimidos

done < archivosTgz
cd ..
#borrado de ficheros
rm archivosp1.1/fileA archivosp1.1/fileB archivosp1.1/fileC archivosp1.1/archivosTgz archivosp1.1/comprimidos

echo "

Para ver los archivos entra en la carpeta archivos p1.1"
