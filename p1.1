#!/bin/bash

#parametros 1--> debe ser /etc/passwd o /etc/shadow (con sudo)

#comprobacion de parametros
if(($# == 2));then
	largo=$1
	dias=$2

else
	largo=5
	dias=300
fi

sudo cat /etc/shadow | cut -d':' -f1,2 | tr ':' ' ' > fileA

#nombre demasiado corto
echo '--------------------------------'
echo "1.Nombres cortos < $largo letras" 
while IFS= read -r line
do
	string=($line)
	#echo "Nombre: ${string[0]} passwd: ${string[1]}"
	if [[ "${string[1]}" != *"*"* ]] && [[ "${string[1]}" != *"error"* ]];then
		if ((${#string[0]} < largo));then
			echo "${string[0]}"
		fi
	fi
done < fileA

#comprobar permisos de sudoers
echo '--------------------------------'
echo "2.Ususarios sudoers" 
cat /etc/passwd | cut -d':' -f1 > fileAb
while IFS= read -r line
do

	groups $line >> grupos

done < fileAb

cat grupos | cut -d':' -f1,2 | tr ':' ' '> fileB

cont=0
while IFS= read -r line
do
	string=($line)
	if [[ "${string[*]}" == *"root"* ]] || [[ "${string[*]}" == *"sudo"* ]];then
		echo "${string[0]}"
		let cont=cont+1
	fi
done < fileB
echo "Hay $cont usuarios con permisos elevados"

echo '--------------------------------'
echo '3. Usuarios que hace demasiados que no cambian la contraseÃ±a'
sudo cat /etc/shadow | cut -d':' -f1,3 | tr ':' ' ' > fileC
echo "$dias dias"
numDiasHastaHoy=$(($(date --utc --date "$1" +%s)/86400))
while IFS= read -r line
do
	string=($line)
	let restaDias=$numDiasHastaHoy-${string[1]} 
	if [ $restaDias -gt $dias ];then
		echo "${string[0]}"
	fi
done < fileC

echo '--------------------------------'
echo '4. Archivos con permisos de ejecucion others'
sudo find ./test -type f -perm /o=x > archivosEjecucionOthers 2> error
cat archivosEjecucionOthers
echo '--------------------------------'
echo '5. Archivos con permisos SUID activado'
sudo find ./test -type f -perm /4000 > archivosSUID 2>> error
cat archivosSUID

echo '--------------------------------'
echo '6. Bit X activado de archivos comprimidos'

mkdir descomprimir
echo "Archivos .tgz" > permisosComprimidos
sudo find ./test -name "*.tgz" > archivosTgz 2>> error
while IFS= read -r line
do
	tar -xvzf $line -C ./descomprimir > salidas
	sudo find ./descomprimir -type f -perm /o=x >> permisosComprimidos 2>> error

done < archivosTgz
echo "Archivos .tar" >> permisosComprimidos
sudo find ./test -name "*.tar" > archivosTgz 2>> error
while IFS= read -r line
do
	tar xvf $line -C ./descomprimir > salidas
	sudo find ./descomprimir -type f -perm /o=x >> permisosComprimidos 2>> error
	cat permisosComprimidos
done < archivosTgz

#borrado de ficheros
rm fileA fileB fileC archivosTgz permisosComprimidos fileAb archivosSUID archivosEjecucionOthers salidas grupos
rm -rf descomprimir

