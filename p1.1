#!/bin/bash

#crear archivos para test
echo "Generando carpeta test"
./test.sh > salidas
#parametros 1--> debe ser /etc/passwd o /etc/shadow (con sudo)

#comprobacion de parametros
if(($# == 2));then
	largo=$1
	dias=$2

else
	largo=5
	dias=300
fi

mkdir archivosp1.1
cat /etc/passwd | cut -d':' -f1,2 | tr ':' ' ' >archivosp1.1/fileA
echo "Mirar carpeta archivosp1.1 para los resultados de cada tarea."

#nombre demasiado corto
echo '--------------------------------'
echo '1. Nombres cortos en archivosp1.1/nombresCortos'
echo "Nombres cortos < $largo letras" > archivosp1.1/nombresCortos
while IFS= read -r line
do
	string=($line)
	if [ "${string[1]}" != *"*"* ];then
		if((${#string[0]} < largo));then
			echo "${string[0]}" >> archivosp1.1/nombresCortos
		fi
	fi
done < archivosp1.1/fileA

#comprobar permisos de sudoers
echo '--------------------------------'
echo '2. Permisos sudoers en archivosp1.1/usuariosconPermisos'
echo "Ususarios sudoers" > archivosp1.1/usuariosconPermisos
cat /etc/passwd | cut -d':' -f1 >archivosp1.1/fileA
while IFS= read -r line
do

	groups $line >> grupos

done < archivosp1.1/fileA

cat grupos | cut -d':' -f1,2 | tr ':' ' '> archivosp1.1/fileB

cont=0
while IFS= read -r line
do
	string=($line)
	if [[ "${string[*]}" == *"root"* ]] || [[ "${string[*]}" == *"sudo"* ]];then
		echo "${string[0]}" >> archivosp1.1/usuariosconPermisos
		let cont=cont+1
	fi
done < archivosp1.1/fileB
echo "Hay $cont usuarios con permisos elevados"

echo '--------------------------------'
echo '3. Usuarios que hace demasiados que no cambian la contraseÃ±a en archivosp1.1/muchotiempoPasswd'
sudo cat /etc/shadow | cut -d':' -f1,3 | tr ':' ' ' > archivosp1.1/fileC
echo "$dias dias"
numDiasHastaHoy=$(($(date --utc --date "$1" +%s)/86400))
while IFS= read -r line
do
	string=($line)
	let restaDias=$numDiasHastaHoy-${string[1]} 
	if [ $restaDias -gt $dias ];then
		echo "${string[0]}" >> archivosp1.1/muchotiempoPasswd
	fi
done < archivosp1.1/fileC

echo '--------------------------------'
echo '4. Permisos others en archivosp1.1/archivosEjecucionOthers'
sudo find ./test -type f -perm /o=x > archivosp1.1/archivosEjecucionOthers 2> error

echo '--------------------------------'
echo '5. Permisos others en archivosp1.1/archivosEjecucionOthers'
sudo find ./test -type f -perm /4000 > archivosp1.1/archivosSUID 2>> error


echo '--------------------------------'
echo '6. Bit X activado de archivos comprimidos en archivosp1.1/permisosComprimidos'

mkdir descomprimir
echo "Archivos .tgz" > archivosp1.1/permisosComprimidos
sudo find ./test -name "*.tgz" > archivosp1.1/archivosTgz 2>> error
while IFS= read -r line
do
	tar -xvzf $line -C ./descomprimir > salidas
	sudo find ./descomprimir -type f -perm /o=x >> archivosp1.1/permisosComprimidos 2>> error

done < archivosp1.1/archivosTgz
echo "Archivos .tar" >> archivosp1.1/permisosComprimidos
sudo find ./test -name "*.tar" > archivosp1.1/archivosTgz 2>> error
while IFS= read -r line
do
	tar xvf $line -C ./descomprimir > salidas
	sudo find ./descomprimir -type f -perm /o=x >> archivosp1.1/permisosComprimidos 2>> error

done < archivosp1.1/archivosTgz

#borrado de ficheros
rm archivosp1.1/fileA archivosp1.1/fileB archivosp1.1/fileC archivosp1.1/archivosTgz salidas grupos
rm -rf descomprimir

